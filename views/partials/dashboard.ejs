<script nonce="<%= nonce %>">
    // dashboard.js

    document.addEventListener('DOMContentLoaded', function () {
        const ctx = document.getElementById('marksChart').getContext('2d');

        const labels = ['Term 1', 'Term 2', 'Term 3'];
        const data = [
            <%= marks_summary && typeof marks_summary.avg_percentage_term1 === 'number' && !isNaN(marks_summary.avg_percentage_term1) ? marks_summary.avg_percentage_term1.toFixed(2) : 0 %>,
            <%= marks_summary && typeof marks_summary.avg_percentage_term2 === 'number' && !isNaN(marks_summary.avg_percentage_term2) ? marks_summary.avg_percentage_term2.toFixed(2) : 0 %>,
            <%= marks_summary && typeof marks_summary.avg_percentage_term3 === 'number' && !isNaN(marks_summary.avg_percentage_term3) ? marks_summary.avg_percentage_term3.toFixed(2) : 0 %>
        ];

        const chart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Average Marks',
                    data: data,
                    backgroundColor: ['#4CAF50', '#FF9800', '#F44336'],
                    borderColor: ['#388E3C', '#FF5722', '#D32F2F'],
                    borderWidth: 1,
                }],
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 10
                        }
                    }
                }
            }
        });
    });

</script>

<div class="p-4 sm:ml-64 dark:bg-gray-900 dark:text-stone-50 mt-20">
    <div class="mb-4">
        <h1 class="text-2xl font-bold">Welcome, <%= teacher.first_name %>
                <%= teacher.last_name %>!</h1>
        <p>
            <%= teacher.school_name %>, <%= teacher.school_address %>
        </p>
        <p>Contact: <%= teacher.school_phone %>
        </p>
    </div>

    <div class="flex gap-5 flex-wrap">
        <!-- Total Students Card -->
        <div class="max-w-sm w-full bg-white rounded-lg shadow dark:bg-gray-800 p-6">
            <h5 class="text-xl font-bold text-gray-900 dark:text-white">Total Students</h5>
            <p class="text-2xl font-bold text-gray-900 dark:text-white">
                <%= total_students || 0 %>
            </p>
        </div>

        <!-- Average Marks (Flowbite Chart) -->
        <div class="max-w-sm w-full bg-white rounded-lg shadow dark:bg-gray-800 p-6">
            <h5 class="text-xl font-bold text-gray-900 dark:text-white">Average Marks</h5>

            <div class="mb-4">
                <canvas id="marksChart"></canvas>
            </div>

            <p class="text-sm text-gray-600 dark:text-gray-300">
                <strong>Term 1:</strong>
                <% if (marks_summary && typeof marks_summary.avg_percentage_term1==='number' &&
                    !isNaN(marks_summary.avg_percentage_term1)) { %>
                    <%= marks_summary.avg_percentage_term1.toFixed(2) %>%
                        <% } else { %>
                            Not available
                            <% } %>
            </p>
            <p class="text-sm text-gray-600 dark:text-gray-300">
                <strong>Term 2:</strong>
                <% if (marks_summary && typeof marks_summary.avg_percentage_term2==='number' &&
                    !isNaN(marks_summary.avg_percentage_term2)) { %>
                    <%= marks_summary.avg_percentage_term2.toFixed(2) %>%
                        <% } else { %>
                            Not available
                            <% } %>
            </p>
            <p class="text-sm text-gray-600 dark:text-gray-300">
                <strong>Term 3:</strong>
                <% if (marks_summary && typeof marks_summary.avg_percentage_term3==='number' &&
                    !isNaN(marks_summary.avg_percentage_term3)) { %>
                    <%= marks_summary.avg_percentage_term3.toFixed(2) %>%
                        <% } else { %>
                            Not available
                            <% } %>
            </p>
        </div>
    </div>

    <div class="mt-8">
        <h2 class="text-xl font-bold">Recent Student Uploads</h2>
        <ul class="list-disc pl-8">
            <% if (recent_files && recent_files.length> 0) { %>
                <% recent_files.forEach(file=> { %>
                    <li>
                        <strong>
                            <%= file.file_name %>
                        </strong> by <%= file.student_name %> on <%= new Date(file.upload_date).toLocaleDateString() %>
                    </li>
                    <% }) %>
                        <% } else { %>
                            <li>No recent uploads available.</li>
                            <% } %>
        </ul>
    </div>
</div>

<!-- FlowbiteChart Script -->
<script src="/js/chart.js" defer></script>